<?php


	function install_mysql()
	{
		global $INTO;
		
		$conn = mysql_connect( $INTO['mysql']['host'], $INTO['mysql']['user'], $INTO['mysql']['pass'] ) or die;
		
		if ( $INTO['mysql']['base'] ) { mysql_select_db( $INTO['mysql']['base'] ); }
		if ( $INTO['mysql']['autoquery'] ) { mysql_query( $INTO['mysql']['autoquery'] ); }
		
		foreach( split( ';', pack('H*', '44524f50205441424c45204946204558495354532060636f6d6d656e7473603b0d0a435245415445205441424c452060636f6d6d656e74736020280d0a20206069645f636f6d6d656e746020696e742831312920756e7369676e6564204e4f54204e554c4c206175746f5f696e6372656d656e742c0d0a20206069645f706172656e746020696e7428313129204e4f54204e554c4c2064656661756c74202730272c0d0a20206069645f66696c656020696e742831312920756e7369676e6564204e4f54204e554c4c2c0d0a20206069645f757365726020696e74283131292064656661756c74204e554c4c2c0d0a2020606461746560206461746574696d65204e4f54204e554c4c2c0d0a202060757365726e616d6560207661726368617228323535292064656661756c74204e554c4c2c0d0a20206074657874602074657874204e4f54204e554c4c2c0d0a202060697060207661726368617228313529204e4f54204e554c4c2c0d0a202060757365726167656e74602074657874204e4f54204e554c4c2c0d0a20205052494d415259204b45592020286069645f636f6d6d656e7460290d0a2920454e47494e453d4d794953414d204155544f5f494e4352454d454e543d312044454641554c5420434841525345543d757466383b0d0a0d0a44524f50205441424c4520494620455849535453206066696c6573603b0d0a435245415445205441424c45206066696c65736020280d0a20206069645f66696c656020696e742831312920756e7369676e6564204e4f54204e554c4c206175746f5f696e6372656d656e742c0d0a20206069645f757365726020696e742831312920756e7369676e6564204e4f54204e554c4c2c0d0a20206066696c656020766172636861722832353529204e4f54204e554c4c2c0d0a2020606d64356020766172636861722832353529204e4f54204e554c4c2c0d0a2020606461746560206461746574696d65204e4f54204e554c4c2c0d0a20206073697a656020696e7428313129204e4f54204e554c4c2c0d0a2020606970602076617263686172283135292064656661756c74204e554c4c2c0d0a202060757365726167656e746020746578742c0d0a2020607075626c69636020696e74283129204e4f54204e554c4c2064656661756c74202730272c0d0a20205052494d415259204b45592020286069645f66696c65602c6069645f7573657260292c0d0a20204b4559206069645f757365726020286069645f7573657260292c0d0a20204b455920606d6435602028606d643560290d0a2920454e47494e453d4d794953414d204155544f5f494e4352454d454e543d312044454641554c5420434841525345543d757466383b0d0a0d0a44524f50205441424c452049462045584953545320607573657273603b0d0a435245415445205441424c45206075736572736020280d0a20206069645f757365726020696e742831312920756e7369676e6564204e4f54204e554c4c206175746f5f696e6372656d656e742c0d0a202060757365726020766172636861722832353529204e4f54204e554c4c2c0d0a2020607077646020766172636861722832353529204e4f54204e554c4c2c0d0a20205052494d415259204b45592020286069645f7573657260290d0a2920454e47494e453d4d794953414d204155544f5f494e4352454d454e543d312044454641554c5420434841525345543d757466383b') ) as $q ) { if ($q) { mysql_query($q) or die; }}
		return true;
	}

	function install_dirs()
	{
		global $INTO;
		
		$path = DOCUMENT_ROOT.'/'.$INTO['schema']['upload'];
		
		if ( file_exists( $path ) ) 
		{
			$root = opendir($path);
			while( $dir = readdir($root) ) 
			{
				if ( !preg_match('/^(\.|\.\.)$/', $dir )) 
				{
					$user = opendir( "$path/$dir" );
					while( $file = readdir($user) ) 
					{
						if ( is_file("$path/$dir/$file") ) { unlink( "$path/$dir/$file" ); }
					}
					closedir($user); 
				}
			}
			closedir($root); 
		}
		else
		{
			mkdir( $path, 0777, true ); 
			chmod($path, 0777); 
		}
		
		return true;
	}
	
	echo "<center><h1>Установка...</h1>";
	if ( install_mysql() ) { echo "<li>Таблицы MySql созданы"; }
	if ( install_dirs() ) { echo "<li>Директории подготовлены"; }
	echo "<h2 style='color:red'>Удалите файл install.php</h2></center>";

?>